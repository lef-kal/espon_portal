<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Title</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="flatly.min.css">

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>

    <style>
      * {
        overflow: unset!important;
      }
      nav {
        z-index: 1050 !important;
      }
      #map {
        /* position: absolute;
        top: 0;
        bottom: 0; */
        min-height: 100vh;
      }
      .feature__p {
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <!-- nav-start-->
    <nav
      class="
        navbar navbar-expand-sm navbar-light
        bg-white
        shadow
        sticky-top
        mb-5
      "
    >
      <a class="navbar-brand ml-5" href="#"
        ><img src="ESPON-logo.png" alt="espon-logo" style="max-height: 70px"
      /></a>
      <button
        class="navbar-toggler d-lg-none"
        type="button"
        data-toggle="collapse"
        data-target="#collapsibleNavId"
        aria-controls="collapsibleNavId"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavId">
        <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
          <li class="nav-item active">
            <a class="nav-link" href="index.html"
              >Home<span class="sr-only">(current)</span></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="explore.html">Explore</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="storytelling.html">Datastories</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="storytelling.html">Dashboards</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="storytelling.html">Data playground</a>
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="dropdownId"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
              >ESPON Tools</a
            >
            <div class="dropdown-menu" aria-labelledby="dropdownId">
              <a class="dropdown-item" href="#">Rimap</a>
              <a class="dropdown-item" href="#">Fuore</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>

    <!-- nav-end-->
    <div class="row mt-5">
      <!--- list-start -->
      <div class="col-lg-5">
        <!-- feature-start-->
        <div class="feature mt-5 ml-5 mr-5">
          <br />
          <span class="badge badge-pill badge-primary">Featured map</span>
          <h3>
            Circular Economy and Territorial Consequences: The case of
            Luxembourg
          </h3>
          <p class="feature__p">
            We published today a new report of our
            <b
              >Circular Economy and Territorial Consequences (CIRCTER)
              project</b
            >. This report will focus on the Grand Duchy of Luxembourg, which,
            at the moment, is developing its national Circular Economy Strategy.
            In this respect, CIRCTER’s evidence provides further critical
            insights into the internal ongoing policy processes carried out by
            different Ministries.
          </p>
          <p class="feature__p">
            <b>Claude Turmes, Minister for Spatial Planning of Luxembourg</b>,
            notes in his forward message:
            <i
              >"The results of ESPON’s CIRCTER spin-off for Luxembourg come at
              the right moment, as they provide valuable data and information
              for setting objectives and drafting roadmaps for implementing
              circular economy principles in key economic sectors. The
              territorial analysis allows for the benchmarking of local and
              national efforts against other regions in Europe and designing
              tailor-made recommendations. The CIRCTER results position
              Luxembourg as one of the cutting-edge European regions in terms of
              circular business models already installed in the country.
            </i>
          </p>
          <p class="feature__p">
            <i
              >On the other hand, the analysis highlights very different
              circularity performance scores across municipalities, thereby
              confirming the need for coherent governance and strong
              institutional cooperation along entire value chains, as identified
              in the National Circular Economy Strategy. This spin-off is also
              an opportunity for the CIRCTER research team to apply the
              project’s methodology and tailor the project’s policy
              recommendations to an almost unique territorial context
              characterised by a high degree of cross-border integration in the
              heart of Europe".
            </i>
          </p>
          <p class="feature__p">
            CIRCTER project produced regional estimates (at NUTS-2 level) for
            the main material consumption and waste generation and treatment
            indicators available from Eurostat. In addition, the CIRCTER project
            developed a sectoral perspective of the circular economy. This
            differentiates between the demand-side and supply-side of circular
            product and/or services
          </p>
        </div>
        <!-- feature-end-->
        <!-- Accordeon start-->
        <!-- <div id="accordion" class="mt-5 ml-5 mr-5 ">
          <div class="card">
            <div class="card-header" id="headingTwo">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  Population and living conditions
                </button>
              </h5>
            </div>
            <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
              <div class="card-body">
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  Environment and Energy
                </button>
              </h5>
            </div>
            <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
              <div class="card-body">
              </div>
            </div>
          </div>
          <div class="card">
              <div class="card-header" id="headingFour">
                <h5 class="mb-0">
                  <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                      Economy, finance and trade
                  </button>
                </h5>
              </div>
              <div id="collapseFour" class="collapse" aria-labelledby="headingFour" data-parent="#accordion">
                <div class="card-body">
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" id="headingFive">
                <h5 class="mb-0">
                  <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseFive">
                  Territorial Structure
                  </button>
                </h5>
              </div>
              <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
                <div class="card-body">
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" id="headingThree">
                <h5 class="mb-0">
                  <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                      Education
                  </button>
                </h5>
              </div>
              <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
                <div class="card-body">
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" id="headingThree">
                <h5 class="mb-0">
                  <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                    Labour market
                  </button>
                </h5>
              </div>
              <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordion">
                <div class="card-body">
                </div>
              </div>
            </div>
      </div> -->
        <!-- Accordeon end-->
      </div>
      <!--- list-end-->

      <!-- map-start-->
      <div class="col-lg-7 mt-5">
        <button type="button" class="btn btn-sm btn-primary" id="flyer" data-toggle="button" aria-pressed="false" autocomplete="off">Focus on area</button>
        <button type="button" class="btn btn-sm btn-primary" id="home" data-toggle="button" aria-pressed="false" autocomplete="off">Home</button>

        <div id="map" class=""></div>
      </div>
      <!-- map-end-->
    </div>
    <!--footer-start-->
    <!-- Footer -->
    <footer class="page-footer bg-white shadow font-small pt-4">
      <!-- Footer Links -->
      <div class="container text-center text-md-left">
        <!-- Footer links -->
        <div class="row text-center text-md-left mt-3 pb-3">
          <!-- Grid column -->
          <div class="col-md-3 col-lg-3 col-xl-3 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">ESPON Portal</h6>
            <p>
              The ESPON EGTC is a European Grouping on Territorial Cooperation.
              ESPON started in 2002 and have continued since then building a
              pan-European knowledge base related to territorial dynamics.
            </p>
          </div>
          <!-- Grid column -->

          <hr class="w-100 clearfix d-md-none" />

          <!-- Grid column -->
          <div class="col-md-2 col-lg-2 col-xl-2 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">Explore</h6>
            <p>
              <a href="#">Datastories</a>
            </p>
            <p>
              <a href="#!">Dashboards</a>
            </p>
            <p>
              <a href="#!">Playground</a>
            </p>
            <p>
              <a href="#!">ESPON tools</a>
            </p>
          </div>
          <!-- Grid column -->

          <hr class="w-100 clearfix d-md-none" />

          <!-- Grid column -->
          <div class="col-md-3 col-lg-2 col-xl-2 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">Useful links</h6>
            <p>
              <a href="#!">ESPON database</a>
            </p>
            <p>
              <a href="#!">ESPON website</a>
            </p>
          </div>

          <!-- Grid column -->
          <hr class="w-100 clearfix d-md-none" />

          <!-- Grid column -->
          <div class="col-md-4 col-lg-3 col-xl-3 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">Contact</h6>
            <p>
              <i class="fas fa-home mr-3"></i>
            </p>
            <p>
              <i class="fas fa-envelope mr-3"></i>
            </p>
            <p>
              <i class="fas fa-phone mr-3"></i>
            </p>
            <p>
              <i class="fas fa-print mr-3"></i>
            </p>
          </div>
          <!-- Grid column -->
        </div>
        <!-- Footer links -->

        <hr />

        <!-- Grid row -->
        <div class="row d-flex align-items-center">
          <!-- Grid column -->
          <div class="col-md-7 col-lg-8">
            <!--Copyright-->
            <p class="text-center text-md-left">
              © 2021 Copyright:
              <a>
                <strong> ESPON EGTC</strong>
              </a>
            </p>
          </div>
          <!-- Grid column -->

          <!-- Grid column -->
          <div class="col-md-5 col-lg-4 ml-lg-0">
            <!-- Social buttons -->
            <div class="text-center text-md-right">
              <ul class="list-unstyled list-inline">
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-facebook-f"></i>
                  </a>
                </li>
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-twitter"></i>
                  </a>
                </li>
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-google-plus-g"></i>
                  </a>
                </li>
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-linkedin-in"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <!-- Grid column -->
        </div>
        <!-- Grid row -->
      </div>
      <!-- Footer Links -->
    </footer>
    <!-- Footer -->

    <!--footer-end-->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
  </body>
  <script>
    const csvUrl = "waste_data.csv";
    const csvPromise = papaPromise(csvUrl);
    //YOUR TURN: Replace with your Mapbox Token
    mapboxgl.accessToken =
      "pk.eyJ1IjoiZWxrYWxvbmFyaXMiLCJhIjoiY2twbXExOHcwMDg3ZzJvbnc0dXhyOWszOSJ9.AetSK7t4L_aaFVsCuNQmHg";

    var map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/elkalonaris/ckqi5rs8aepjs18nqpd7lmx4m", // YOUR TURN: choose a style: https://docs.mapbox.com/api/maps/#styles
      zoom: 3, // zoom level
      maxZoom: 6,
      minZoom: 3,
      center: [12, 56],
      transformRequest: transformRequest,
    });

    map.on("load", function () {
      csvPromise.then(function (results) {
        results.data.forEach((row) => {
          map.setFeatureState(
            {
              //YOUR TURN: Replace with your source tileset and source layer
              source: "NUTS_RG_10M_2013_4326_LEVL_2-344mre",
              sourceLayer: "NUTS_RG_10M_2013_4326_LEVL_2-344mre",
              //YOUR TURN: Replace with unqiue ID row name
              id: row.tunit_code,
            },
            //YOUR TURN: Add rows you want to style/interact with
            {
              name: row.tunit_name,
              values: row.y_2014,
            }
          );
        });
      });
      //YOUR TURN: Add source layer
      map.addSource("NUTS_RG_10M_2013_4326_LEVL_2-344mre", {
        type: "vector",
        url: "mapbox://elkalonaris.3tp4ou5e",
        promoteId: "NUTS_ID",
        generateId: true,
      });
      map.addLayer({
        id: "region-layer",
        type: "fill",
        source: "NUTS_RG_10M_2013_4326_LEVL_2-344mre",
        "source-layer": "NUTS_RG_10M_2013_4326_LEVL_2-344mre",
        layout: {},
        paint: {
          "fill-color": [
            "interpolate",
            ["linear"],
            ["to-number", ["feature-state", "values"]],
            13688,
            "#ffb784",
            20753739,
            "#007db4",
          ],
        },
      });
    });
    var popup = new mapboxgl.Popup({
      closeButton: false,
      closeOnClick: false,
    });

    map.on("mousemove", 'region-layer',function (e) {
      map.getCanvas().style.cursor = "pointer";

      var theLayer = "region-layer"
      var region = map.queryRenderedFeatures(e.point, {
        layers: [theLayer],
      });
      // console.log(region);
      var props = region[0].properties;
      var val = region[0].state;

      var r = region[0].layer.paint["fill-color"]["r"].toFixed(2);
      var g = region[0].layer.paint["fill-color"]["g"].toFixed(2);
      var b = region[0].layer.paint["fill-color"]["b"].toFixed(2);

      var R = (255 * r).toFixed(0);
      var G = (255 * g).toFixed(0);
      var B = (255 * b).toFixed(0);

      var color = "rgba(" + [R, G, B].join(",") + ",1)";
      var theValues = val.values.toLocaleString();
      var theNames = val.name;

      var content = "<b>" + props.NUTS_NAME + "</b>" + "<br>";
      content += "NUTS_2 code: " + props.FID + "<br>";
      content += "Region: " + props.NUTS_NAME + "<br>";
      content +=
        "<div class='something'>" +
        "<b>" +
        "Waste: " +
        theValues +
        "</b>" +
        " per capita" +
        "</div>" +
        "<br>";
      content += '<canvas id="bar-chart-horizontal" height="100"></canvas>';

      popup.setLngLat(e.lngLat).setHTML(content).addTo(map);


      const ctx = document
        .getElementById("bar-chart-horizontal")
        .getContext("2d");

      var myChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: [theNames],
          datasets: [
            {
              label: "",
              data: [theValues],
              backgroundColor: [color],
            },
          ],
        },
        options: {
          indexAxis: "y",
          legend: { display: false },
          scaleShowLabels : false,
          plugins: {
            legend: {
              display: false,
            },
          },
          title: {
            display: false,
          },
          scales: {
            x: {
              min: 100,
              suggestedMax: 10000000,
            },
          },
          yAxes: [
            {
              
              display: false,
              
            },
          ],
        },
      });
    });
    map.on('idle', function(e) {
      var region = map.queryRenderedFeatures(e.point, {
        layers: ['region-layer'],
      });
      console.log(region)
      var values = []
      for(var i=0; i < 299; i++){
      var arr = region[i].state.values
      // console.log(arr)
      values.push(arr)
      
      // var maxPeak = arr.sort((p, c) => p - c)[0];
      // console.log(maxPeak);
    }
    var max = values.sort((a, b) => b - a)[0]
    var min = values.sort((a,b)=> a-b)[0]
    console.log(max)
    console.log(min)
    })

    map.on("mouseleave", "region-layer", function () {
      map.getCanvas().style.cursor = "";
      // myChart.destroy();
      popup.remove();
    });

    function transformRequest(url, resourceType) {
      var isMapboxRequest =
        url.slice(8, 22) === "api.mapbox.com" ||
        url.slice(10, 26) === "tiles.mapbox.com";
      return {
        url: isMapboxRequest ? url.replace("?", "?pluginName=dataJoins&") : url,
      };
    }
    document.getElementById('flyer').addEventListener('click', function () {
    // Fly to a random location by offsetting the point -74.50, 40
    // by up to 5 degrees.
    map.flyTo({
    center: [
    6, 49
    ],
    zoom: 12.5,
    essential: true // this animation is considered essential with respect to prefers-reduced-motion
    });
    });
    document.getElementById('home').addEventListener('click', function () {
    // Fly to a random location by offsetting the point -74.50, 40
    // by up to 5 degrees.
    map.flyTo({
      zoom: 3, // zoom level
      center: [12, 56],
    essential: true // this animation is considered essential with respect to prefers-reduced-motion
    });
    });
    function papaPromise(url) {
      return new Promise(function (resolve, reject) {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: resolve,
        });
      });
    }
  </script>
</html>
