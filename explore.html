<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ESPON Portal</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <script src="https://cdn.plot.ly/plotly-2.2.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="https://unpkg.com/underscore@1.13.1/underscore-umd-min.js
    "></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="flatly.min.css">
    <script
      src="https://code.jquery.com/jquery-3.6.0.js"
      integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <!-- <link rel="stylesheet" href="flatly.min.css"> -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css"
      rel="stylesheet"
    />

    <style>
      * {
        overflow: unset!important;
        scroll-behavior: smooth;
      }
      section{
        max-width: 1350px;
        margin: auto
      }
      .territories{
          width: 98%;
      }
      nav {
        z-index: 1050 !important;
      }
      .buttons-nuts{
          width: 100%;
      }
      .down-ind{
          width: 90%;
      }
      #map {
        /* position: absolute;
        top: 0;
        bottom: 0; */
        min-height: 550px;
        height: 600px;
        max-height: 750px;
        
        border-left: 10px solid blue;
        border-right: 10px solid blue;
      }
      .attribution{
        font-size: 10px;
      }
      .only-top{
        border-top: 2px solid blue;

      }
      .only-left{
        border-left: 10px solid blue;
        height: 40px;
        margin-left: 12px;

      }
      .only-right{
        border-right: 10px solid blue;
        height: 60px;
      margin-right: 12px!important;
      }
      .feature__p {
        font-size: 13px;
      }
      .card-body {
        padding: 0;
      }
      .spinner{display: none;}
    </style>
  </head>
  <body>
    <!-- nav-start-->
    <nav class="navbar navbar-expand-sm navbar-light bg-white shadow mb-5">
      <a class="navbar-brand ml-5" href="#"
        ><img src="ESPON-logo.png" alt="espon-logo" style="max-height: 70px"
      /></a>
      <button
        class="navbar-toggler d-lg-none"
        type="button"
        data-toggle="collapse"
        data-target="#collapsibleNavId"
        aria-controls="collapsibleNavId"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="collapsibleNavId">
        <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="index.html"
              >Home</a
            >
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="explore.html">Explore</a>
          </li>
          <li class="nav-item ">
            <a class="nav-link" href="datastory.html">Datastories</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">Dashboards</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="https://hypertechsa.github.io/espon-playground/" target="_blank">Data playground</a>
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="dropdownId"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
              >ESPON Tools</a
            >
            <div class="dropdown-menu" aria-labelledby="dropdownId">
              <a class="dropdown-item" href="#">Rimap</a>
              <a class="dropdown-item" href="#">Fuore</a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <!-- nav-end-->
    <section>
    <div class="row first">
      <!--- list-start -->
      <div class="col-lg-5 sidebar">
        <!-- feature-start-->

        <!-- feature-end-->
        <!-- Accordeon start-->
        <div id="accordion" class="mt-5 ml-5 mr-5 sticky-top">
          <div class="card">
            <div class="card-header" id="headingTwo">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-ind="2183"
                  data-toggle="collapse"
                  data-target="#collapseTwo"
                  aria-expanded="false"
                  aria-controls="collapseTwo"
                >
                  Population and living conditions
                </button>
              </h5>
            </div>
            <div
              id="collapseTwo"
              class="collapse"
              aria-labelledby="headingTwo"
              data-parent="#accordion"
            >
              <div class="card-body">
                <div class="list-group">
                  
                  <a
                    href="#"
                    class="list-group-item list-group-item-action changer"
                    data-ind="2183" data-mt="Population+by+sex"
                    >Population by NUTS 2 regions</a
                  >
                  <a
                    href="#"
                    class="list-group-item list-group-item-action disabled"
                    >Female population by NUTS 2 regions</a
                  >
                  <a
                    href="#"
                    class="list-group-item list-group-item-action disabled"
                    >Male population by NUTS 2 regions</a
                  >
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseThree"
                  aria-expanded="false"
                  aria-controls="collapseThree"
                  disabled
                >
                  Environment and Energy
                </button>
              </h5>
            </div>
            <div
              id="collapseThree"
              class="collapse"
              aria-labelledby="headingThree"
              data-parent="#accordion"
            >
              <div class="card-body"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingFour">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseFour"
                  aria-expanded="false"
                  aria-controls="collapseFour"
                  disabled
                >
                  Economy, finance and trade
                </button>
              </h5>
            </div>
            <div
              id="collapseFour"
              class="collapse"
              aria-labelledby="headingFour"
              data-parent="#accordion"
            >
              <div class="card-body"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingFive">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseThree"
                  aria-expanded="false"
                  aria-controls="collapseFive"
                  disabled
                >
                  Territorial Structure
                </button>
              </h5>
            </div>
            <div
              id="collapseThree"
              class="collapse"
              aria-labelledby="headingThree"
              data-parent="#accordion"
            >
              <div class="card-body"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseThree"
                  aria-expanded="false"
                  aria-controls="collapseThree"
                >
                  Education
                </button>
              </h5>
            </div>
            <div
              id="collapseThree"
              class="collapse"
              aria-labelledby="headingThree"
              data-parent="#accordion"
            >
              <div class="card-body">
                <a
                    href="#"
                    class="
                      list-group-item list-group-item-action
                      changer
                    "
                    data-ind="1393" data-mt="Total+number+of+material+cultural+heritage+objects"
                    >Total number of material cultural heritage objects</a
                  >
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseThree"
                  aria-expanded="false"
                  aria-controls="collapseThree"
                  disabled
                >
                  Labour market
                </button>
              </h5>
            </div>
            <div
              id="collapseThree"
              class="collapse"
              aria-labelledby="headingThree"
              data-parent="#accordion"
            >
              <div class="card-body"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseThree"
                  aria-expanded="false"
                  aria-controls="collapseThree"
                  disabled
                >
                  Agriculture and fisheries
                </button>
              </h5>
            </div>
            <div
              id="collapseThree"
              class="collapse"
              aria-labelledby="headingThree"
              data-parent="#accordion"
            >
              <div class="card-body"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseThree"
                  aria-expanded="false"
                  aria-controls="collapseThree"
                  disabled
                >
                  Science and technology
                </button>
              </h5>
            </div>
            <div
              id="collapseThree"
              class="collapse"
              aria-labelledby="headingThree"
              data-parent="#accordion"
            >
              <div class="card-body"></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header" id="headingThree">
              <h5 class="mb-0">
                <button
                  class="btn btn-link collapsed"
                  data-toggle="collapse"
                  data-target="#collapseThree"
                  aria-expanded="false"
                  aria-controls="collapseThree"
                  disabled
                >
                  Transport & accessibility
                </button>
              </h5>
            </div>
            <div
              id="collapseThree"
              class="collapse"
              aria-labelledby="headingThree"
              data-parent="#accordion"
            >
              <div class="card-body"></div>
            </div>
          </div>
        </div>
        <!-- Accordeon end-->


      </div>
      <!--- list-end-->

      <!-- map-start-->
      <div class="col-lg-7">
        <div class="row">
          <div class="col-lg-12">
            <div id="metadata">
              <p class="placeholder">
                Choose an indicator from the list to start exploring.
              </p>

            </div>
          </div>
        </div>
        <div class="row">

          <div class="col-lg-3">
            <div class="form-group">
              <select
                class="form-control form-control-sm"
                name=""
                id="area-focus"
              >
              <option default>Focus on area</option>

              </select>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="btn-group btn-group-sm buttons-nuts">
              <button type="button" class="btn btn-outline-primary" disabled>
                NUTS 0
              </button>
              <button type="button" class="btn btn-outline-primary" disabled>
                NUTS 1
              </button>
              <button type="button" class="btn btn-primary">NUTS 2</button>
              <button type="button" class="btn btn-outline-primary" disabled>
                NUTS 3
              </button>
            </div>
          </div>
          <div class="col-lg-3">
            <button type="button" class="btn btn-sm btn-primary down-ind" id='modal-button'data-toggle="modal" data-target="#exampleModal" disabled>
              Download &#160; <i class="bi bi-download"></i>
            </button>
            
            <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Retrieve indicator data</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <h6>
                      Download options
                    </h6>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="defaultCheck1" disabled>
                      <label class="form-check-label" for="defaultCheck1">
                        Include metadata
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="defaultCheck2" disabled>
                      <label class="form-check-label" for="defaultCheck2">
                        Include null values
                      </label>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-primary"> <a id="csv">CSV</a> </button>
                    <button type="button" class="btn btn-sm btn-primary"> <a id='json'>JSON</a></button>
                    <button type="button" class="btn btn-sm btn-primary" disabled> <a id='geojson'>GeoJSON</a></button>
                    <button type="button" class="btn btn-sm btn-primary" disabled> <a id='shape'>Shape (zip)</a></button>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
            <div class="col-lg-12 mr-auto territories">
                <div class="form-group">
                    <select
                      class="form-control form-control-sm"
                      name=""
                    >
                    <option default>EU27+EFTA</option>
                    <option>EU neighbourhood</option>
                    <option>EU Strategy for the Balkan Sea Region (EUSBSR)</option>
                    <option>EU Strategy for the Alpine Region (EUSALP)</option>
                    <option>EU Strategy for the Danube Region (EUSDR)</option>
                    <option>EU Strategy for the Adriatic and Ionian Region (EUSAIR)</option>
                    <option>Adriatic-Ionian</option>
                    <option>Balkan mediterranean</option>
                    <option>North Sea</option>
                    <option>North West Europe</option>
                    <option>Danube</option>
                    </select>
                  </div>
                
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 only-left"></div>
    <div class="row">
      <div class="col-lg-3  col-sm-2 col-md-2 only-top"></div>
      <div class="col-lg-8"></div>
      <div class="col-lg-1"></div>
    </div>
    <div class="row">
      <div class="col-lg-12">
        <div id="map" class=""></div>

      </div>
    </div>
    <div class="row">
      <div class="col-lg-8"></div>
      <div class="col-lg-4  col-sm-2 col-md-2 only-top"></div>
    </div>
    <div class="row">
      <div class="col-lg-11 ml-auto only-right text-right attribution">
        <span></span> <br>
        <span></span> <br>
        <span></span> <br>
      </div>
      </div>
          </div>
        
 
        <div class="col-lg-12">
          <div class="text-center spinner mt-5" >
            <div class="spinner-border" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          <div id="chartID"></div>
        </div>
        <div class="col-lg-12">
          <div class="text-center spinner mt-5" >
            <div class="spinner-border" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          <table id="output" class="mb-5 mt-5">
            <thead>
              <tr>
                  <th>Tunit</th>
                  <th>Name</th>
                  <th>Value</th>

              </tr>
          </thead>
          </table>
        </div>
      </div>
      <!-- map-end-->
    </div>
</section>
    <!--footer-start-->
    <!-- Footer -->
    <footer class="page-footer bg-white shadow font-small pt-4">
      <!-- Footer Links -->
      <div class="container text-center text-md-left">
        <!-- Footer links -->
        <div class="row text-center text-md-left mt-3 pb-3">
          <!-- Grid column -->
          <div class="col-md-3 col-lg-3 col-xl-3 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">ESPON Portal</h6>
            <p>
              The ESPON EGTC is a European Grouping on Territorial Cooperation.
              ESPON started in 2002 and have continued since then building a
              pan-European knowledge base related to territorial dynamics.
            </p>
          </div>
          <!-- Grid column -->

          <hr class="w-100 clearfix d-md-none" />

          <!-- Grid column -->
          <div class="col-md-2 col-lg-2 col-xl-2 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">Explore</h6>
            <p>
              <a href="#">Datastories</a>
            </p>
            <p>
              <a href="#!">Dashboards</a>
            </p>
            <p>
              <a href="#!">Playground</a>
            </p>
            <p>
              <a href="#!">ESPON tools</a>
            </p>
          </div>
          <!-- Grid column -->

          <hr class="w-100 clearfix d-md-none" />

          <!-- Grid column -->
          <div class="col-md-3 col-lg-2 col-xl-2 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">Useful links</h6>
            <p>
              <a href="#!">ESPON database</a>
            </p>
            <p>
              <a href="#!">ESPON website</a>
            </p>
          </div>

          <!-- Grid column -->
          <hr class="w-100 clearfix d-md-none" />

          <!-- Grid column -->
          <div class="col-md-4 col-lg-3 col-xl-3 mx-auto mt-3">
            <h6 class="text-uppercase mb-4 font-weight-bold">Contact</h6>
            <p>
              <i class="fas fa-home mr-3"></i>
            </p>
            <p>
              <i class="fas fa-envelope mr-3"></i>
            </p>
            <p>
              <i class="fas fa-phone mr-3"></i>
            </p>
            <p>
              <i class="fas fa-print mr-3"></i>
            </p>
          </div>
          <!-- Grid column -->
        </div>
        <!-- Footer links -->

        <hr />

        <!-- Grid row -->
        <div class="row d-flex align-items-center">
          <!-- Grid column -->
          <div class="col-md-7 col-lg-8">
            <!--Copyright-->
            <p class="text-center text-md-left">
              Â© 2021 Copyright:
              <a>
                <strong> ESPON EGTC</strong>
              </a>
            </p>
          </div>
          <!-- Grid column -->

          <!-- Grid column -->
          <div class="col-md-5 col-lg-4 ml-lg-0">
            <!-- Social buttons -->
            <div class="text-center text-md-right">
              <ul class="list-unstyled list-inline">
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-facebook-f"></i>
                  </a>
                </li>
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-twitter"></i>
                  </a>
                </li>
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-google-plus-g"></i>
                  </a>
                </li>
                <li class="list-inline-item">
                  <a class="btn-floating btn-sm rgba-white-slight mx-1">
                    <i class="fab fa-linkedin-in"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <!-- Grid column -->
        </div>
        <!-- Grid row -->
      </div>
      <!-- Footer Links -->
    </footer>
    <!-- Footer -->

    <!--footer-end-->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
  </body>
  <script>

function mapExists(map) {
        if (map && Object.keys(map).length > 0) {
          if (map.style && Object.keys(map.style).length > 0) {
            return true;
          } else {
            return false;
          }
        } else {
          return false;
        }
      }
  
    
  </script>
  <script>

      $('.list-group-item').click(function () {

        $('.list-group-item.active').removeClass('active')
        $(this).addClass('active')

       })
  </script>
  <script>

    $(".changer").on("click", function () {
      $('#chartID').hide()
      $('#output').hide()
      var hoveredStateId = null;

      const theButton = document.getElementById('modal-button');
      theButton.setAttribute('disabled', 'disabled');
      $('.spinner').show()

      mapExists() && map.remove()
      var mtdt = []
      var metadata = $(this).attr("data-mt");
      var mturl = "https://database.espon.eu/api/select/indicators?";
      var mtparams = "name" + "=" + metadata;
      $.getJSON(mturl + mtparams, function (data) {
      var mtDisplay = '<h4>' + data.results[0].name + '</h4>'
      mtDisplay += '<p> Project: <strong>' + data.results[0].project + ' </strong> <br>'
      mtDisplay += 'Indicator type: <strong>' + data.results[0].set_type + ' </strong> </br>'
      mtDisplay += 'Available spatial extent: <strong>' + data.results[0].spatial_exts[0] + ' </strong><br>'
      mtDisplay += 'Available years: <strong>' + data.results[0].years_string + ' </strong> <br>'
      mtDisplay += 'Territorial level: <strong>' + data.results[0].territorial_level[0].nomenclature +data.results[0].territorial_level[0].level + '</strong> </p>'
        $('#metadata').html(mtDisplay)
        console.log(data)

        let version = data.results[0].territorial_level[0].nomenclature

      })
      // var nm = metadata.name
      // var mtDisplay = '<h6>' + nm + '</h6>'
      // mtDisplay += '<span>' + metadata[0].project + '</span>'



      var chartTitle = $(this).innerHTML;
      // console.log(chartTitle)
      $('#chartTitle').html(chartTitle)
      mapboxgl.accessToken =
        "pk.eyJ1IjoiZWxrYWxvbmFyaXMiLCJhIjoiY2twbXExOHcwMDg3ZzJvbnc0dXhyOWszOSJ9.AetSK7t4L_aaFVsCuNQmHg";

      var map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/light-v10",
        zoom: 3, // zoom level
        maxZoom: 6,
        minZoom: 3,
        center: [12, 56],
        transformRequest: transformRequest,
      });
      map.triggerRepaint();
      var toDownload = []
      var chartData = [[], [], []];
      var ind = $(this).attr("data-ind");
      var url = "https://database.espon.eu/api/select/indicator-data/?";
      var params = "obj" + "=" + ind;
      map.on("load", function () {
        $.getJSON(url + params, function (data) {
          data.forEach((row) => {
            chartData[0].push(row.value);
            chartData[1].push(row.tunit[0].tunit_name);
            chartData[2].push(row.tunit[0].tunit_code);
            toDownload.push({tunit: row.tunit[0].tunit_code, name: row.tunit[0].tunit_name, value: row.value})
            map.setFeatureState(
              {
                source: "NUTS_RG_03M_2016_4326_LEVL_2.geojson",
                //YOUR TURN: Replace with unqiue ID row name
                id: row.tunit[0].tunit_code,
              },
              {
                name: row.tunit[0].tunit_name,
                value: row.value,
              }
            );
            //loop
          });

          //get-json
        });

        // console.log(chartData)
        //scale
        var scale = new mapboxgl.ScaleControl({
          maxWidth: 80,
          unit: "imperial",
        });
        map.addControl(scale);
        scale.setUnit("metric");
        //scale
        var layers = map.getStyle().layers;
          var firstSymbolId;
          for (var i = 0; i < layers.length; i++) {
          if (layers[i].type === 'symbol') {
          firstSymbolId = layers[i].id;
          break;
          }
        }
        // console.log(firstSymbolId)

        //core-map
        map.addSource("NUTS_RG_03M_2016_4326_LEVL_2.geojson", {
          type: "geojson",
          data: "data/NUTS_RG_03M_2016_4326_LEVL_2.geojson",
          generateId: true,
          promoteId: "FID"
        });
        map.addLayer({
          id: "regional",
          type: "fill",
          source: "NUTS_RG_03M_2016_4326_LEVL_2.geojson",
          layout: {},
          paint: {
            'fill-opacity': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            1,
            0.7
            ],
            'fill-outline-color': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            'white',
            'transparent'
            ],
            "fill-color": [
              "interpolate",
              ["linear"],
              ["to-number", ["feature-state", "value"]],
              0,
              'transparent',
              1,
              "#ffb784",
              10000000,
              "#007db4",
            ],
          },
          
        },firstSymbolId);
        // map.addLayer({
        //   id: "regional-line",
        //   type: "line",
        //   source: "NUTS_RG_03M_2016_4326_LEVL_2.geojson",
        //   "source-layer": "NUTS_RG_03M_2016_4326_LEVL_2.geojson",
        //   layout: {},
        //   paint: {
        //     "line-color": 'lightgray',
        //     'line-width': 0.1
        //   },
        // });
        //core-map-end

        //options-start
        setTimeout((timely) => {
          for (var i = 0; i < chartData[1].length; i++) {
            var opt1 = chartData[2][i];
            var opt2 = chartData[1][i];
            var el = document.createElement("option");
            el.textContent = opt1 + ": " + opt2;
            el.value = opt1;
            $("#area-focus").append(el);
          }
          //       ;

        }, 1400);
        //options-end

        //box-plot-start
        setTimeout((theTime) => {
          var region = map.queryRenderedFeatures({
            layers: ["regional"],
          })
          // for(let z=0;z < region.length; z++){
          // var colored = []
          // var r = region[i].layer.paint["fill-color"]["r"].toFixed(2);
          // var g = region[i].layer.paint["fill-color"]["g"].toFixed(2);
          // var b = region[i].layer.paint["fill-color"]["b"].toFixed(2);

          // var R = (255 * r).toFixed(0);
          // var G = (255 * g).toFixed(0);
          // var B = (255 * b).toFixed(0);
          // var toPush = "rgba(" + [R, G, B].join(",") + ",1)";
          // colored.push(toPush)
          // }

          // console.log(colored)
          
          var boxPlotData = [
            {
              y: chartData[0],
              boxpoints: "all",
              jitter: 0.3,
              pointpos: -1.8,
              text: chartData[1],
              type: "box",
              name: 'Region data',
              marker:{
              color: 'rgba(0,120,255,0.4)'
              },
              boxmean: 'sd'
            },
          ];
          console.log(this)
          $('.spinner').hide()
          $('#chartID').show()
          theButton.removeAttribute('disabled')
          let csvContent = "data:text/csv;charset=utf-8,"
          + chartData.map(e => e.join(",")).join("\n");
          var encodedUri = encodeURI(csvContent);
          
          var clAnchorElem = document.getElementById('csv');
              // clAnchorElem.setAttribute("href",     csvContent     );
              // clAnchorElem.setAttribute("download", "ind.csv");
            $(clAnchorElem).on('click', function () { 
              window.open(csvContent)
             })

        // var dataStr = "data:text/json;charset=utf-8," + JSON.stringify(chartData);
        var dataStr = JSON.stringify(toDownload);


        var dlAnchorElem = document.getElementById('json');
            // dlAnchorElem.setAttribute("href",     dataStr     );
            // dlAnchorElem.setAttribute("download", "scene.json");

            $(dlAnchorElem).on('click', function () { 
              window.open(dataStr)
             })
             $('#output').show()
              $('#output').DataTable({
                destroy: true,
                data: toDownload,
                columns: [
                    { data: 'tunit' },
                    { data: 'name' },
                    { data: 'value' },
                ]
            } );
        Plotly.newPlot("chartID", boxPlotData);

        $('.paginate_button .current').css({'background-color':'#2c3e50', 'background':'#2c3e50'})
        }, 1400);
        //boxplot-end

        //pop-up-start
        var popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
        });
        map.on("mousemove", "regional", function (e) {
          map.getCanvas().style.cursor = "pointer";

          var region = map.queryRenderedFeatures(e.point, {
            layers: ["regional"],
          });

          if (e.features.length > 0) {
            if (hoveredStateId !== null) {
            map.setFeatureState(
            { source: 'NUTS_RG_03M_2016_4326_LEVL_2.geojson', id: hoveredStateId },
            { hover: false }
            );
            }
            hoveredStateId = e.features[0].id;
            map.setFeatureState(
            { source: 'NUTS_RG_03M_2016_4326_LEVL_2.geojson', id: hoveredStateId },
            { hover: true }
            );
            }
          var props = region[0].properties;
          var val = region[0].state;
          var theValue = val.value.toLocaleString()

          var content = "<b>" + props.NUTS_NAME + "</b>" + "<br>";
          content += "Tunit code: " + props.FID + "<br>";
          content += "Region: " + props.NUTS_NAME + "<br>";
          content += "Value: " + "<b>" + theValue + "</b>";

          popup.setLngLat(e.lngLat).setHTML(content).addTo(map);
        });
          map.on("mouseleave", "regional", function () {
          map.getCanvas().style.cursor = "";

          popup.remove();
        });
        //pop-up-end

        //metadata-start
        setTimeout((time) => {
            var max = chartData[0].sort((a, b) => b - a)[0]
            var min = chartData[0].sort((a,b)=> a-b)[0]
            var maxPosition = chartData[0].indexOf(max)
            var minPosition = chartData[0].indexOf(min)
            var maxName = chartData[1][maxPosition]
            var minName = chartData[1][minPosition]
            // console.log(maxName)
            // console.log(minName)
            // function isMaximum(valueThis) { 
            //   return valueThis.
            //  }
            // document.getElementById('chartTitle').innerHTML= '<span>The maximum value identified is ' + max.toLocaleString() + ' at '+maxName+'</span> <span> and the min is  ' +min.toLocaleString()+' at ' +minName+ '</span>'
        },1000)
          // 

        //metadata-end
        map.on('idle', 'regional', function () {  
          var theRegion = map.queryRenderedFeatures({
            layers: ["regional"],
          });
          console.log(theRegion)
          
        // $('select').on('change', function () { 
        //     var tunitValue = $(this).val()
        //     // var focusCoordinated = region.find(obj => obj.name === props.NUTS_ID)
        //    })
        //    console.log(tunitValue)
          })
        //map-end
      });



      //transformrequest-function-start
      function transformRequest(url, resourceType) {
        var isMapboxRequest =
          url.slice(8, 22) === "api.mapbox.com" ||
          url.slice(10, 26) === "tiles.mapbox.com";
        return {
          url: isMapboxRequest
            ? url.replace("?", "?pluginName=dataJoins&")
            : url,
        };
      }
      //transform-request-function-end

    });
  </script>
</html>
